<video-js id="my_video_1" class="vjs-default-skin vjs-big-play-centered vjs-fluid"></video-js>
<link href="https://unpkg.com/video.js@8.6.0/dist/video-js.min.css" rel="stylesheet" />
<script src="https://unpkg.com/video.js@8.6.0/dist/video.min.js"></script>
<script src="https://s.stevie.top/fastly.jsdelivr.net/npm/video.js@8/dist/lang/zh-Hans.min.js"></script>
<script src="https://unpkg.com/swarmcloud-hls@2.8.4/dist/p2p-engine.min.js"></script>
<script type="module">
  const src = (new URLSearchParams(location.search)).get('src')
    || 'https://hono.dgcf.link/s5.bfzycdn.com/video/feichangxiaotewudajuezhan/HD/index.m3u8'

  //https://www.cdnbye.com/oms/#/user/liveDataGlobal
  const player = videojs('my_video_1', {
    logLevel: true,
    autoplay: false,
    controls: true,
    playbackRates: [0.5, 1, 1.5, 2, 3, 4, 5],
    language: 'zh-Hans',
    languages: {
      'zh-Hans': {
        "Now Playing": "正在播放",
        "Up Next": "播放下一个",
        "Untitled Video": "无标题视频"
      }
    },
    html5: {
      //https://github.com/videojs/http-streaming#list
      vhs: {}
    }
  });
  //https://swarmcloud.net/cn/views/hls-de/API.html#p2penginehls-api
  const engine = new P2PEngineHls({
    // logLevel: 'debug',
    live: false,
    // sharePlaylist: true,
    // token: 'Ta-XNIdZg',
    // trackerZone: 'hk',
    swFile: '/worker-swarmcloud.js',
    getStats(totalP2PDownloaded, totalP2PUploaded, totalHTTPDownloaded) {
      const total = totalHTTPDownloaded + totalP2PDownloaded;
      const stats = `p2p ratio: ${Math.round(totalP2PDownloaded/total*100)}%, saved traffic: ${totalP2PDownloaded}KB, uploaded: ${totalP2PUploaded}KB`
      console.log(stats)
    },
    getPeerId (peerId) {
      console.log('peerId: ', peerId)
    },
    getPeersInfo (peers) {
      console.log('peersInfo: ' + peers)
    }
  })
  function dataUrlToObjectUrl(dataUrl) {
    if(!/^data:/.test(dataUrl)) return dataUrl
    const byteString = atob(dataUrl.replace(/^.*?,/, ''));
    const uint8Array = (new Uint8Array(new ArrayBuffer(byteString.length)))
      .map((i, idx) => byteString.charCodeAt(idx));

    return URL.createObjectURL(
      new Blob([uint8Array],
        { type: dataUrl.replace(/^data:(.*?)[;,].*$/, '$1') })
    );
  }
  //https://github.com/swarm-cloud/hls-p2p-engine/blob/main/demo/videojs-vhs.html
  engine.registerServiceWorker().finally(async () => {
    player.src({
      src: dataUrlToObjectUrl(src),
      type: 'application/x-mpegURL'
    })
  })
</script>
