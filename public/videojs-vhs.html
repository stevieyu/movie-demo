<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<div>
    <video-js id="my_video_1" class="vjs-default-skin vjs-big-play-centered vjs-fluid" />
</div>
<div id="logs"></div>
<link href="https://s.stevie.top/fastly.jsdelivr.net/npm/video.js@8.6.0/dist/video-js.min.css" rel="stylesheet" />
<script src="https://s.stevie.top/fastly.jsdelivr.net/npm/video.js@8.6.0/dist/video.min.js"></script>
<script src="https://s.stevie.top/fastly.jsdelivr.net/npm/video.js@8/dist/lang/zh-Hans.min.js"></script>
<script src="https://s.stevie.top/fastly.jsdelivr.net/npm/swarmcloud-hls@2.8.4/dist/p2p-engine.min.js"></script>

  <script src="https://s.stevie.top/fastly.jsdelivr.net/npm/eruda" crossorigin="anonymous"></script>
  <script>eruda.init()</script>

<style>
    .video-js *:focus-visible{
        outline: none;
    }
    .vjs-menu li.vjs-menu-item:focus{
        background-color: transparent !important;
    }
</style>

<script type="module">
  const src = (new URLSearchParams(location.search)).get('src')
    || 'https://pptv.1080tg.com/202309/22/riJyehH5nR3/video/index.m3u8'

  //https://www.cdnbye.com/oms/#/user/liveDataGlobal
  const player = videojs('my_video_1', {
    logLevel: true,
    autoplay: false,
    controls: true,
    playbackRates: [0.5, 1, 1.5, 2, 3, 4, 5],
    language: 'zh-Hans',
    languages: {
      'zh-Hans': {
        "Now Playing": "正在播放",
        "Up Next": "播放下一个",
        "Untitled Video": "无标题视频"
      }
    },
    html5: {
      //https://github.com/videojs/http-streaming#list
      vhs: {}
    }
  });
  const logs = (...args) => document.querySelector('#logs').innerHTML += `<div>${args.join(' ')}</div>`;
  //https://swarmcloud.net/cn/views/hls-de/API.html#p2penginehls-api
  const engine = new P2PEngineHls({
    // logLevel: 'debug',
    live: false,
    // sharePlaylist: true,
    // token: 'Ta-XNIdZg',
    trackerZone: 'hk',
    swFile: '/worker-swarmcloud.js',
    webRTCConfig: {
      iceServers: [
        { urls: [ 'stun:stun.hitv.com:3478',
            'stun:ss-turn2.xirsys.com',] }
      ]
    },
    getStats(totalP2PDownloaded, totalP2PUploaded, totalHTTPDownloaded) {
      const total = totalHTTPDownloaded + totalP2PDownloaded;
      const stats = `p2p ratio: ${Math.round(totalP2PDownloaded/total*100)}%, saved traffic: ${totalP2PDownloaded}KB, uploaded: ${totalP2PUploaded}KB`
      logs(stats)
    },
    getPeerId (peerId) {
      logs('peerId: ', peerId)
    },
    getPeersInfo (peers) {
      logs('peersInfo: ' + peers)
    }
  })
  function dataUrlToObjectUrl(dataUrl) {
    if(!/^data:/.test(dataUrl)) return dataUrl
    const byteString = atob(dataUrl.replace(/^.*?,/, ''));
    const uint8Array = (new Uint8Array(new ArrayBuffer(byteString.length)))
      .map((i, idx) => byteString.charCodeAt(idx));

    return URL.createObjectURL(
      new Blob([uint8Array],
        { type: dataUrl.replace(/^data:(.*?)[;,].*$/, '$1') })
    );
  }
  //https://github.com/swarm-cloud/hls-p2p-engine/blob/main/demo/videojs-vhs.html
  engine.registerServiceWorker().finally(async () => {
    player.src({
      src: dataUrlToObjectUrl(src),
      type: 'application/x-mpegURL'
    })

    addEventListener('beforeunload', () => {
      navigator.serviceWorker.getRegistrations().then((registrations) => {
        for (let registration of registrations) {
          if(!registration.active.scriptURL.includes(engine.realEngine.config.swFile)) continue;
          registration.unregister();
        }
      });
    });
  })
</script>
