<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<link rel="stylesheet" href="https://jsd.onmicrosoft.cn/combine/npm/modern-normalize/modern-normalize.min.css"/>
<script src="https://jsd.onmicrosoft.cn/combine/npm/swarmcloud-hls/dist/hls.min.js,npm/artplayer/dist/artplayer.js"></script>
<style>
    body {
        background: #000;
        color: #ccc
    }

    #artplayer-app {
        position: relative;
        min-height: 200px;
    }
    #artplayer-app .art-video-player {
        min-width: 100%;
        min-height: 100%;
        max-height: 100vw;
        position: absolute;
    }
    .art-layer-title{
        width:100%;
        background: linear-gradient(130deg, rgba(0,0,0,.4), rgba(0,0,0,.1));
        color: #ccc;
        position: absolute;
        top: 0;
        left: 0;
        padding:.2em;
        transition: transform .2s;
        transform: translateY(-100%);
    }
    .art-control-show .art-layer-title{
        transform: translateY(0%);
    }
</style>

<div id="artplayer-app"></div>
<div contenteditable="true" id="textarea" style="width: 100%;">THE NEW GATE$$$第01集$https://v12.fentvoss.com/sdv12/202404/14/YgsfDTKdNC84/video/index.m3u8
第02集$https://v4.fentvoss.com/sdv4/202404/21/vD03jKnmXg76/video/index.m3u8
第03集$https://v12.fentvoss.com/sdv12/202404/28/69v7M5yhwQ84/video/index.m3u8
第04集$https://v12.fentvoss.com/sdv12/202405/05/60advRWazK84/video/index.m3u8
第05集$https://v11.fentvoss.com/sdv11/202405/12/yDgUufHjmc3/video/index.m3u8</div>
<div id="logs"></div>

<script type="module">
  const {title, list} = (() => {
    const el = document.querySelector('#textarea')
    el.addEventListener('keyup', e => {
      if(e.key === 'Enter') {
        e.preventDefault()
        sessionStorage.setItem('config', e.target.innerText)
        location.reload()
      }
    })
    const config = sessionStorage.getItem('config') || el.innerText.trim()
    el.value = config

    const src = new URLSearchParams(location.search).get('src') || ''

    return {
      title: config.replace(/([^${3}]+).*/s, '$1'),
      list: [
        (src ? {
          html: 'src',
          url: new URLSearchParams(location.search).get('src') || ''
        } : null),
        ...config.replace(/([^${3}]+)\${3}/s, '')
        .split(` `)
        .map(i => (i.match(/(?<html>.*?)\$(?<url>.*)/) || {}).groups)

      ].filter(i => i)
    }
  })()

  const logVar = {}
  const logs = () => document.querySelector('#logs').innerHTML = Object.values(logVar).join('<br/>');
  //https://swarmcloud.net/cn/views/hls-de/API.html#p2penginehls-api
  const p2pConfig = {
    // logLevel: 'debug',
    // live: false,
    sharePlaylist: true,
    trackerZone: 'hk',
    swFile: '/worker-swarmcloud.js',
    getStats(totalP2PDownloaded, totalP2PUploaded, totalHTTPDownloaded) {
      const total = totalHTTPDownloaded + totalP2PDownloaded;
      logVar.stats = `p2p ratio: ${Math.round(totalP2PDownloaded / total * 100)}%, saved traffic: ${totalP2PDownloaded}KB, uploaded: ${totalP2PUploaded}KB`
      logs()
    },
    getPeerId(peerId) {
      logVar.peerId = 'peerId: ' + peerId
      logs()
    },
    getPeersInfo(peers) {
      logVar.peerId = 'peersInfo: ' + peers
      logs()
    }
  }

  const playList = (option = {}) => {
    return (art) => {
      return {
        name: 'playList',
      }
    }
  }

  //https://www.artplayer.org/document/start/option.html
  window.art = new Artplayer({
    container: '#artplayer-app',
    // url: '',
    type: 'm3u8',
    customType: {
      m3u8: (video, url, art) => {
        if (Hls.P2pEngine.isMSESupported()) {
          const hls = new Hls({
            p2pConfig
          });
          hls.loadSource(url);
          hls.attachMedia(video);
        } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
          video.src = url;
          // use ServiceWorker based p2p engine if hls.js is not supported
          new Hls.P2pEngine(p2pConfig)
        }
      },
    },
    plugins: [
      playList({
        title,
        list,
      })
    ],
    autoplay: true,
    pip: true,
    autoSize: true,
    autoMini: true,
    setting: true,
    playbackRate: true,
    fullscreen: true,
    // fullscreenWeb: true,
    miniProgressBar: true,
    mutex: true,
    playsInline: true,
    autoPlayback: true,
  });

  const setTitle = (subtitle = '') => {
    if(!setTitle.title) return;
    const html = `${setTitle.title || ''} ${subtitle}`
    const name = 'title'
    if(!setTitle.init) {
      setTitle.init = 1;
      art.layers.add({
        name,
        html,
      });
      return
    }
    art.layers.update({
      name,
      html,
    });
  }
  setTitle.title = title
  setTitle();


  art.setting.add({
    name: 'analecta',
    html: '选集',
    tooltip: '',
    selector: list,
    onSelect: (item, _dom, _e) => {
      playSwitchItem(item)
      return item.html;
    },
  });

  const switchShowNextBtn = () => {
    if(!art.controls.nextEpisode) {
      art.controls.add({
        name: 'nextEpisode',
        index: 20,
        position: 'left',
        html: `<svg xmlns="http://www.w3.org/2000/svg" width="1.8em" height="1.8em" viewBox="0 0 24 24"><path fill="currentColor" d="M20.095 21a.75.75 0 0 1-.75-.75V3.75a.75.75 0 0 1 1.5 0v16.5a.74.74 0 0 1-.75.75m-3.4-9.589a2.25 2.25 0 0 1-.85 1.82l-9.11 7.09c-.326.247-.713.4-1.12.44h-.23a2.142 2.142 0 0 1-1-.22a2.201 2.201 0 0 1-.9-.81a2.17 2.17 0 0 1-.33-1.16V5.421a2.22 2.22 0 0 1 .31-1.12a2.25 2.25 0 0 1 .85-.8a2.18 2.18 0 0 1 2.24.1l9.12 6.08c.29.191.53.448.7.75a2.3 2.3 0 0 1 .32.98"/></svg>`,
        tooltip: '下一集',
        click: () => {
          playNext()
        },
      });
    }
    const nextIdx = playNextIdx()
    if(isNaN(nextIdx)) {
      art.controls.update({
        name: 'nextEpisode',
        tooltip: '无',
      })
      return
    }
  }

  const playSwitchItem = (item) => {
    art.storage.set('storageSelectorDefaultUrl', item.url);
    list.forEach(i => (i.default = false))
    item.default = true
    art.switchUrl(item.url)
    setTitle(item.html);
    switchShowNextBtn()
  }
  const playCurrentIdx = () => {
    const sAnalecta = art.setting.find('analecta')

    if(sAnalecta && !sAnalecta.index) {
      const storageSelectorDefaultUrl = art.storage.get('storageSelectorDefaultUrl');
      sAnalecta.index = storageSelectorDefaultUrl ? list.findIndex(i => i.url === storageSelectorDefaultUrl) : 0
    }

    return sAnalecta.index
  }
  const playNextIdx = () => {
    const idx = playCurrentIdx() + 1
    if(idx >= list.length) return NaN
    return idx
  }
  const playSwitchIdx = (idx = NaN) => {
    if(isNaN(idx)) idx = playCurrentIdx()
    if(idx >= list.length) return
    const item = list[idx < 0 ? 0 : idx]
    if(!item) return

    playSwitchItem(item)
    if(art.setting.find('analecta')) art.setting.update({name: 'analecta', tooltip: item.html})
  }
  playSwitchIdx()

  const playNext = () => {
    const nextIdx = playNextIdx()
    if(!isNaN(nextIdx)) playSwitchIdx(nextIdx)
  }

  art.on('video:ended', () => {
    playNext();
  });

  art.on('ready', () => {
    art.autoHeight();
  });
  art.on('resize', () => {
    art.autoHeight();
  });
</script>
