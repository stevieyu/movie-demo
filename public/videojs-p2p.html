<video id="video" class="video-js vjs-default-skin vjs-big-play-centered vjs-fluid" controls></video>
<script src="https://unpkg.com/p2p-media-loader-core@0.6.2/build/p2p-media-loader-core.min.js"></script>
<script src="https://unpkg.com/p2p-media-loader-hlsjs@0.6.2/build/p2p-media-loader-hlsjs.min.js"></script>

<link href="https://unpkg.com/video.js@7.21.5/dist/video-js.min.css" rel="stylesheet" />
<script src="https://unpkg.com/video.js@7.21.5/dist/video.min.js"></script>

<script type="module">
  const src = (new URLSearchParams(location.search)).get('src')
    || 'https://hono.dgcf.link/s5.bfzycdn.com/video/feichangxiaotewudajuezhan/HD/index.m3u8'

  if (p2pml.hlsjs.Engine.isSupported()) {
    //https://github.com/Novage/p2p-media-loader/blob/master/FAQ.md
    var engine = new p2pml.hlsjs.Engine({
      loader: {
        trackerAnnounce: [
          "wss://bittorrent-tracker.zeabur.app",
        ],
        rtcConfig: {
          iceServers: [
            { urls: "stun:stun.l.google.com:19302" },
            { urls: "stun:global.stun.twilio.com:3478?transport=udp" }
          ]
        }
      }
    });

    engine.on("peer_connect", peer => console.log("peer_connect", peer.id, peer.remoteAddress));
    engine.on("peer_close", peerId => console.log("peer_close", peerId));
    engine.on("segment_loaded", (segment, peerId) => peerId && console.log("segment_loaded from", `peer ${peerId}`));


    var player = videojs("video", {
      autoplay: false,
      controls: true,
      preload: 'auto',
      playbackRates: [0.5, 1, 1.5, 2, 3, 4, 5],
      html5: {
        hlsjsConfig: {
          // liveSyncDurationCount: 2, // 队列中至少有 2 个分段
          loader: engine.createLoaderClass(),
        },
      },
    });

    p2pml.hlsjs.initVideoJsContribHlsJsPlayer(player);

    player.src({
      src,
      type: "application/x-mpegURL",
    });

    player.ready(() => {
    });
  } else {
    document.write("Not supported :(");
  }
</script>